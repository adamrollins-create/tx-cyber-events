name: Weekly Texas Cyber Events

on:
  schedule:
    # Mondays at ~8am Central (GitHub cron is UTC)
    - cron: "0 13 * * 1"
  workflow_dispatch:

# Prevent two runs from fighting over git state
concurrency:
  group: tx-cyber-events
  cancel-in-progress: true

# Required so the workflow can create commits + pull requests
permissions:
  contents: write
  pull-requests: write

jobs:
  collect:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run event collector
        run: |
          python collect_events.py

      # Always upload outputs + logs, even if parsing is partial
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tx-cyber-events-output
          path: |
            events.csv
            events.ics
            run_log.json
            debug_html/

      # âœ… THIS replaces git commit + git push
      - name: Create Pull Request with outputs
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: Weekly export
          title: Weekly export
          body: Automated update of events.csv, events.ics, and run_log.json
          branch: bot/weekly-export
          delete-branch: true
          add-paths: |
            events.csv
            events.ics
            run_log.json
